# Phase 8: PLAYER_EVENT ì¤‘ë³µ ë° ì˜¤íƒ ë¶„ì„ ë³´ê³ ì„œ

## ğŸ“‹ **ë¬¸ì œ ìš”ì•½**

ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ì™€ ì‹¤ì œ audio.logì˜ PLAYER_EVENTê°€ ë¶ˆì¼ì¹˜í•©ë‹ˆë‹¤.

| ì‹œê°„ | ì‚¬ìš©ì í–‰ë™ | ì˜ˆìƒ PLAYER_EVENT | ì‹¤ì œ PLAYER_EVENT | ë¬¸ì œì  |
|------|-------------|-------------------|-------------------|--------|
| 22:47:45 | ê¸°ë³¸ ì¹´ë©”ë¼ 1ë²ˆ ì´¬ì˜ | 1ê°œ | **2ê°œ** | +1 ì¤‘ë³µ |
| 22:49:56 | ì¹´ì¹´ì˜¤í†¡ ì¹´ë©”ë¼ 1ë²ˆ ì´¬ì˜ | 1ê°œ (kakao pkg) | 1ê°œ (camera pkg) | íŒ¨í‚¤ì§€ ì˜¤ë¶„ë¥˜ |
| 22:55:39 | í…”ë ˆê·¸ë¨ ì¹´ë©”ë¼ 1ë²ˆ ì´¬ì˜+ì „ì†¡ | 1ê°œ | **3ê°œ** | +2 ì¤‘ë³µ |
| 22:57:02 | í…”ë ˆê·¸ë¨ ì•¨ë²” ì „ì†¡ | 0ê°œ | **1ê°œ** | ì˜¤íƒ |

---

## ğŸ” **ìƒì„¸ ë¡œê·¸ ë¶„ì„**

### **ë¬¸ì œ 1: ê¸°ë³¸ ì¹´ë©”ë¼ ì¤‘ë³µ (22:47:40~51)**

```log
465: 10-06 22:47:40:743 new player piid:311 uid/pid:10123/14297 package:com.sec.android.app.camera
466: 10-06 22:47:45:699 player piid:311 event:started  â† PLAYER_EVENT #1
467: 10-06 22:47:49:103 player piid:311 event:started  â† PLAYER_EVENT #2 (3.4ì´ˆ í›„)
468: 10-06 22:47:51:198 releasing player piid:311, uid:10123
```

#### **ì›ì¸ ë¶„ì„**
- **ë™ì¼í•œ player (piid:311)** ì—ì„œ 2ë²ˆ `event:started` ë°œìƒ
- ì‹œê°„ ê°„ê²©: **3,404ms** (3.4ì´ˆ)
- í˜„ì¬ EventDeduplicator ì„ê³„ê°’: **Â±100ms**
- **ê²°ê³¼**: ì¤‘ë³µ ì œê±°ë˜ì§€ ì•ŠìŒ â†’ 2ê°œì˜ CameraCaptureEvent ìƒì„±

#### **ê°€ëŠ¥í•œ ì›ì¸**
1. **ì‹¤ì œë¡œ 2ë²ˆ ì´¬ì˜**: ì‚¬ìš©ìê°€ ë¹ ë¥´ê²Œ ì—°ì† ì´¬ì˜í–ˆì„ ê°€ëŠ¥ì„±
2. **Preview + Capture ì‚¬ìš´ë“œ**: ì¹´ë©”ë¼ UI í”¼ë“œë°± + ì‹¤ì œ ì´¬ì˜ìŒ
3. **Auto-focus ì‚¬ìš´ë“œ**: ì´ˆì  ë§ì¶¤ ì‚¬ìš´ë“œ + ì´¬ì˜ìŒ

---

### **ë¬¸ì œ 2: ì¹´ì¹´ì˜¤í†¡ ì¸í…íŠ¸ ì¹´ë©”ë¼ (22:49:52~50:01)**

```log
471: 10-06 22:49:52:846 new player piid:343 uid/pid:10123/14297 package:com.sec.android.app.camera
472: 10-06 22:49:56:798 player piid:343 event:started  â† ì¹´ì¹´ì˜¤í†¡ì´ ì´¬ì˜í–ˆì§€ë§Œ camera pkg
473: 10-06 22:50:01:879 releasing player piid:343, uid:10123
```

#### **ì›ì¸ ë¶„ì„**
- **package: com.sec.android.app.camera** (ê¸°ë³¸ ì¹´ë©”ë¼)
- **uid: 10123** (ê¸°ë³¸ ì¹´ë©”ë¼ UID)
- í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” **ì¹´ì¹´ì˜¤í†¡ì´ Intentë¡œ ê¸°ë³¸ ì¹´ë©”ë¼ë¥¼ í˜¸ì¶œ**

#### **ë¬¸ì œì **
- audio.logì—ëŠ” **í˜¸ì¶œí•œ ì•±(ì¹´ì¹´ì˜¤í†¡)ì´ ê¸°ë¡ë˜ì§€ ì•ŠìŒ**
- **PackageName ê¸°ì¤€ í•„í„°ë§ ì‹œ ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ë¶„ë¥˜ë¨**
- Ground Truthì™€ ë¶ˆì¼ì¹˜

---

### **ë¬¸ì œ 3: í…”ë ˆê·¸ë¨ ì¤‘ë³µ + ì•¨ë²” ì˜¤íƒ (22:55:39~57:02)**

```log
477: 10-06 22:55:39:363 new player piid:375 uid/pid:10366/20586 package:org.telegram.messenger
478: 10-06 22:55:39:364 player piid:375 event:started  â† ì´¬ì˜ #1
479: 10-06 22:55:39:368 player piid:375 event:started  â† ì´¬ì˜ #2 (4ms í›„, ì¤‘ë³µ)
480: 10-06 22:57:02:200 player piid:375 event:started  â† ì•¨ë²” ì „ì†¡ (82ì´ˆ í›„, ì˜¤íƒ)
releasing player ë¡œê·¸ ì—†ìŒ (ì„¸ì…˜ ì¢…ë£Œ ì „ê¹Œì§€ player ìœ ì§€)
```

#### **ì›ì¸ ë¶„ì„**
1. **478 vs 479**: ì‹œê°„ ê°„ê²© **4ms** â†’ **ì¤‘ë³µì¼ ê°€ëŠ¥ì„± 99%**
   - í˜„ì¬ ì„ê³„ê°’ Â±100ms â†’ ì¤‘ë³µ ì œê±° **ê°€ëŠ¥**
   - í•˜ì§€ë§Œ EventDeduplicatorëŠ” ë‹¤ë¥¸ ì´ë²¤íŠ¸ë¡œ ì¸ì‹ ê°€ëŠ¥

2. **480 (22:57:02)**: ì‹œê°„ ê°„ê²© **82ì´ˆ (82,832ms)**
   - ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤: "í…”ë ˆê·¸ë¨ ì•¨ë²” ì‚¬ì§„ ì „ì†¡ (22:57:01)"
   - **ì˜¤íƒ**: ì•¨ë²” ì „ì†¡ ì‹œ ë°œìƒí•œ PLAYER_EVENTë¥¼ ì´¬ì˜ìœ¼ë¡œ ì˜¤ì¸
   - playerê°€ releaseë˜ì§€ ì•Šì•„ ë™ì¼ piid:375 ì‚¬ìš©

#### **í•µì‹¬ ë¬¸ì œ**
- **playerê°€ ì„¸ì…˜ ì „ì²´ì— ê±¸ì³ ìœ ì§€ë¨** (create â†’ ì—¬ëŸ¬ action â†’ release)
- **ëª¨ë“  `event:started`ë¥¼ ì´¬ì˜ìœ¼ë¡œ ì˜¤ì¸**
- ì•¨ë²” ì „ì†¡, ë¯¸ë¦¬ë³´ê¸°, ê¸°íƒ€ UI ì‚¬ìš´ë“œë„ ì´¬ì˜ìœ¼ë¡œ íƒì§€

---

## ğŸ¯ **ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸**

### **1. PLAYER_EVENTì˜ ëª¨í˜¸ì„±**
| ì´ë²¤íŠ¸ | ë°œìƒ ì›ì¸ | ì´¬ì˜ ì—¬ë¶€ |
|--------|-----------|-----------|
| `player event:started` | ì‹¤ì œ ì´¬ì˜ | âœ… ì´¬ì˜ |
| `player event:started` | ì•¨ë²” ì „ì†¡ UI ì‚¬ìš´ë“œ | âŒ ì˜¤íƒ |
| `player event:started` | Auto-focus ì‚¬ìš´ë“œ | âŒ ì˜¤íƒ |
| `player event:started` | Preview ì‚¬ìš´ë“œ | âŒ ì˜¤íƒ |
| `player event:started` | ë©”ì‹œì§€ ì „ì†¡ ì‚¬ìš´ë“œ | âŒ ì˜¤íƒ |

**ê²°ë¡ **: `PLAYER_EVENT`ë§Œìœ¼ë¡œëŠ” **ì´¬ì˜ì„ í™•ì •í•  ìˆ˜ ì—†ìŒ**

### **2. ì¸í…íŠ¸ ì¹´ë©”ë¼ì˜ íŒ¨í‚¤ì§€ ì˜¤ë¶„ë¥˜**
- ì¹´ì¹´ì˜¤í†¡ â†’ ê¸°ë³¸ ì¹´ë©”ë¼ Intent â†’ audio.logì— `com.sec.android.app.camera` ê¸°ë¡
- **í˜¸ì¶œí•œ ì•±(calling app) ì •ë³´ ë¶€ì¬**
- activity.logë‚˜ usagestats.logë¥¼ í†µí•´ ì‹¤ì œ foreground ì•± í™•ì¸ í•„ìš”

### **3. ì„¸ì…˜ ì „ì²´ì— ê±¸ì¹œ Player ì¬ì‚¬ìš©**
- í…”ë ˆê·¸ë¨ì˜ ê²½ìš° playerë¥¼ ì„¸ì…˜ ë‚´ë‚´ ìœ ì§€
- **ì—¬ëŸ¬ ì•¡ì…˜ì—ì„œ ë™ì¼ player ì¬ì‚¬ìš©** â†’ ëª¨ë“  ì‚¬ìš´ë“œë¥¼ ì´¬ì˜ìœ¼ë¡œ ì˜¤ì¸

---

## ğŸ’¡ **í•´ê²° ë°©ì•ˆ**

### **ë°©ì•ˆ A: PLAYER_EVENTë¥¼ ì¡°ê±´ë¶€ ì£¼ ì¦ê±°ì—ì„œ ì œì™¸** â­ **ê°•ë ¥ ì¶”ì²œ**

#### **ë³€ê²½ ì‚¬í•­**
```csharp
// CameraCaptureDetector.cs
private static readonly HashSet<string> ConditionalPrimaryEvidenceTypes = new()
{
    // LogEventTypes.PLAYER_EVENT,         // âŒ ì œê±°: ë„ˆë¬´ ëª¨í˜¸í•¨
    LogEventTypes.URI_PERMISSION_GRANT,    // ìœ ì§€
    LogEventTypes.SILENT_CAMERA_CAPTURE    // ìœ ì§€
};
```

#### **ì˜í–¥**
- âœ… **ì˜¤íƒ ëŒ€í­ ê°ì†Œ** (ì•¨ë²” ì „ì†¡, UI ì‚¬ìš´ë“œ ì œì™¸)
- âœ… **í…”ë ˆê·¸ë¨ ì¤‘ë³µ ë¬¸ì œ í•´ê²°** (PLAYER_EVENTê°€ ë” ì´ìƒ ì£¼ ì¦ê±° ì•„ë‹˜)
- âš ï¸ **ì£¼ì˜**: í™•ì • ì£¼ ì¦ê±°(`DATABASE_INSERT` ë“±)ê°€ ì—†ìœ¼ë©´ ì´¬ì˜ ë¯¸íƒì§€ ê°€ëŠ¥
- âš ï¸ **ê¸°ë³¸ ì¹´ë©”ë¼ë„ ì˜í–¥**: DATABASE ë¡œê·¸ê°€ ì—†ìœ¼ë©´ íƒì§€ ë¶ˆê°€

#### **ì™„í™” ì „ëµ**
- `PLAYER_EVENT`ëŠ” **ë³´ì¡° ì¦ê±°**ë¡œë§Œ ì‚¬ìš© (ì´ë¯¸ êµ¬í˜„ë¨)
- `URI_PERMISSION_GRANT` + `PLAYER_EVENT` ì¡°í•©ìœ¼ë¡œ í…”ë ˆê·¸ë¨ íƒì§€ ì‹œë„

---

### **ë°©ì•ˆ B: PLAYER_EVENT í•„í„°ë§ ê°•í™”**

#### **êµ¬í˜„ ë°©ë²•**
1. **ì‹œê°„ ê¸°ë°˜ í•„í„°ë§** (EventDeduplicator ê°•í™”)
   ```csharp
   // PLAYER_EVENT ì¤‘ë³µ ì œê±° ì„ê³„ê°’: Â±100ms â†’ Â±500ms
   TimeThresholds[LogEventTypes.PLAYER_EVENT] = 500;
   ```
   - âœ… í…”ë ˆê·¸ë¨ 478, 479 ì¤‘ë³µ ì œê±° ê°€ëŠ¥
   - âŒ 480 (82ì´ˆ í›„)ì€ ì—¬ì „íˆ ì˜¤íƒ

2. **ì„¸ì…˜ ë‚´ ì²« ë²ˆì§¸ PLAYER_EVENTë§Œ ì¸ì •**
   ```csharp
   // CameraCaptureDetector.cs
   // ì„¸ì…˜ ë‚´ ì²« Xê°œì˜ PLAYER_EVENTë§Œ ì£¼ ì¦ê±°ë¡œ ì‚¬ìš© (ì˜ˆ: ì²« 2ê°œ)
   var sessionPlayerEvents = conditionalPrimaryEvidences
       .Where(e => e.EventType == LogEventTypes.PLAYER_EVENT)
       .OrderBy(e => e.Timestamp)
       .Take(2) // ì„¸ì…˜ ì´ˆë°˜ì˜ PLAYER_EVENTë§Œ
       .ToList();
   ```
   - âœ… ì„¸ì…˜ í›„ë°˜ ì•¨ë²” ì „ì†¡ ì‚¬ìš´ë“œ ì œì™¸
   - âš ï¸ Magic number (2ê°œ) ë„ì…

3. **Player ID ê¸°ë°˜ ì¤‘ë³µ ì œê±°**
   ```csharp
   // ë™ì¼í•œ piidì—ì„œ ë°œìƒí•œ ì—¬ëŸ¬ event:started ì¤‘ ì²« ë²ˆì§¸ë§Œ ì¸ì •
   // Attributes["piid"]ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
   var uniquePlayerEvents = conditionalPrimaryEvidences
       .Where(e => e.EventType == LogEventTypes.PLAYER_EVENT)
       .GroupBy(e => e.Attributes.GetValueOrDefault("piid"))
       .Select(g => g.OrderBy(e => e.Timestamp).First())
       .ToList();
   ```
   - âœ… piid:311ì˜ 2ë²ˆ started â†’ 1ê°œë§Œ ì„ íƒ
   - âœ… piid:375ì˜ 3ë²ˆ started â†’ 1ê°œë§Œ ì„ íƒ
   - âš ï¸ ì•¨ë²” ì „ì†¡ë„ ì²« ë²ˆì§¸ë¡œ ê°„ì£¼ë  ìˆ˜ ìˆìŒ

#### **í‰ê°€**
- âœ… ì¤‘ë³µ ê°ì†Œ
- âŒ **ê·¼ë³¸ ë¬¸ì œ ë¯¸í•´ê²°** (ì•¨ë²” ì „ì†¡, UI ì‚¬ìš´ë“œëŠ” ì—¬ì „íˆ ì˜¤íƒ)
- âŒ ë³µì¡ë„ ì¦ê°€

---

### **ë°©ì•ˆ C: ë‹¤ë¥¸ ë¡œê·¸ ì†ŒìŠ¤ í™œìš©** ğŸŒŸ **ì¥ê¸° ê¶Œì¥**

#### **1. URI_PERMISSION_GRANT ê¸°ë°˜ íƒì§€ ê°•í™”**
```csharp
// í…”ë ˆê·¸ë¨/ì¹´ì¹´ì˜¤í†¡: URI_PERMISSION_GRANTë¥¼ ì£¼ ì¦ê±°ë¡œ ì¸ì •
// ë‹¨, content://media/external/... (ì•¨ë²” ê²½ë¡œ)ëŠ” ì œì™¸
private bool IsNewCaptureUriPermission(NormalizedLogEvent evidence)
{
    if (!evidence.Attributes.TryGetValue("uri", out var uriObj))
        return false;
    
    var uri = uriObj?.ToString() ?? "";
    
    // ì•¨ë²” ê²½ë¡œ ì œì™¸
    if (uri.Contains("content://media/external/images/media/"))
        return false;
    
    // ì„ì‹œ ì´¬ì˜ íŒŒì¼ ê²½ë¡œë§Œ ì¸ì •
    return uri.Contains("/tmp/") || uri.Contains("/cache/");
}
```

#### **2. Activity Foreground í™•ì¸** (usagestats.log, activity.log)
```csharp
// ì´¬ì˜ ì‹œì ì˜ foreground ì•± í™•ì¸
// ì¹´ì¹´ì˜¤í†¡ì´ foregroundì´ê³  ê¸°ë³¸ ì¹´ë©”ë¼ê°€ ì´¬ì˜í–ˆë‹¤ë©´ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë¶„ë¥˜
var foregroundApp = GetForegroundApp(captureTime, activityEvents);
if (foregroundApp == "com.kakao.talk" && capture.PackageName == "com.sec.android.app.camera")
{
    capture.PackageName = "com.kakao.talk"; // ì¬ë¶„ë¥˜
    capture.IsIntentCapture = true; // ìƒˆ í•„ë“œ ì¶”ê°€
}
```

#### **3. DATABASE_INSERT ìš°ì„  í™œìš©**
- í˜„ì¬ 4ì°¨ ìƒ˜í”Œì—ëŠ” DATABASE ë¡œê·¸ ì—†ìŒ
- 5ì°¨ ìƒ˜í”Œë¶€í„° DATABASE ë¡œê·¸ ìˆ˜ì§‘ í•„ìš”
- DATABASE_INSERTê°€ ìˆìœ¼ë©´ **PLAYER_EVENT ë¬´ì‹œ**

---

## ğŸ“Š **ê¶Œì¥ ìš°ì„ ìˆœìœ„**

### **ì¦‰ì‹œ ì ìš© (Phase 8)**
1. **ë°©ì•ˆ A**: `PLAYER_EVENT`ë¥¼ ì¡°ê±´ë¶€ ì£¼ ì¦ê±°ì—ì„œ ì œê±° â­
   - ê°€ì¥ ì•ˆì „í•˜ê³  íš¨ê³¼ì 
   - ì˜¤íƒ ëŒ€í­ ê°ì†Œ
   - ì½”ë“œ ìˆ˜ì • ìµœì†Œ

2. **ë°©ì•ˆ B-1**: EventDeduplicator ì„ê³„ê°’ ì¡°ì • (Â±100ms â†’ Â±500ms)
   - í…”ë ˆê·¸ë¨ 478, 479 ì¤‘ë³µ ì œê±°
   - ë¶€ì‘ìš© ìµœì†Œ

### **Phase 9 ê°œì„ **
3. **ë°©ì•ˆ C-1**: URI_PERMISSION_GRANT í•„í„°ë§ ê°•í™”
   - í…”ë ˆê·¸ë¨/ì¹´ì¹´ì˜¤í†¡ ì •í™•ë„ í–¥ìƒ
   - ì•¨ë²” vs ì´¬ì˜ êµ¬ë¶„

4. **ë°©ì•ˆ C-2**: Activity Foreground í™•ì¸
   - ì¸í…íŠ¸ ì¹´ë©”ë¼ ì •í™•í•œ ë¶„ë¥˜
   - usagestats.log íŒŒì‹± í•„ìš”

### **ì¥ê¸° (Phase 10+)**
5. **DATABASE ë¡œê·¸ ìˆ˜ì§‘**
   - ì£¼ ì¦ê±° í™•ë³´ë¡œ ê·¼ë³¸ í•´ê²°
   - 5ì°¨ ìƒ˜í”Œë¶€í„° ì ìš©

---

## ğŸ¯ **ê²°ë¡ **

### **í•µì‹¬ ë¬¸ì œ**
**`PLAYER_EVENT`ëŠ” ì´¬ì˜ í™•ì • ì¦ê±°ë¡œ ë¶€ì í•©í•©ë‹ˆë‹¤.**
- ì•¨ë²” ì „ì†¡, UI ì‚¬ìš´ë“œ, ê¸°íƒ€ ì•¡ì…˜ì—ì„œë„ ë°œìƒ
- íŠ¹íˆ í…”ë ˆê·¸ë¨ì²˜ëŸ¼ ì„¸ì…˜ ì „ì²´ì— playerë¥¼ ìœ ì§€í•˜ëŠ” ì•±ì—ì„œ ì˜¤íƒ ë°œìƒ

### **ê¶Œì¥ ì¡°ì¹˜**
1. âœ… **`PLAYER_EVENT`ë¥¼ ì¡°ê±´ë¶€ ì£¼ ì¦ê±°ì—ì„œ ì œê±°** (ë°©ì•ˆ A)
2. âœ… **EventDeduplicator ì„ê³„ê°’ Â±500msë¡œ ì¡°ì •** (ë°©ì•ˆ B-1)
3. ğŸ”„ **Phase 9**: URI_PERMISSION_GRANT í•„í„°ë§ ê°•í™”
4. ğŸ”„ **Phase 10**: DATABASE ë¡œê·¸ ì¶”ê°€ ìˆ˜ì§‘

### **ì˜ˆìƒ íš¨ê³¼**
| ë¬¸ì œ | í˜„ì¬ | ë°©ì•ˆ A+B ì ìš© í›„ |
|------|------|------------------|
| ê¸°ë³¸ ì¹´ë©”ë¼ ì¤‘ë³µ | 2ê°œ | DATABASE ë¡œê·¸ í•„ìš” (ë¯¸íƒì§€) |
| ì¹´ì¹´ì˜¤í†¡ ë¶„ë¥˜ | ê¸°ë³¸ ì¹´ë©”ë¼ | Phase 9ì—ì„œ í•´ê²° |
| í…”ë ˆê·¸ë¨ ì¤‘ë³µ | 3ê°œ | URI_PERMISSION í™œìš© (Phase 9) |
| í…”ë ˆê·¸ë¨ ì•¨ë²” ì˜¤íƒ | 1ê°œ | âœ… 0ê°œ (í•´ê²°) |

---

**ì‘ì„±ì¼**: 2025-10-07  
**ë²„ì „**: 1.0  
**ìƒíƒœ**: ë°©ì•ˆ ê²€í†  ì™„ë£Œ, êµ¬í˜„ ëŒ€ê¸°

