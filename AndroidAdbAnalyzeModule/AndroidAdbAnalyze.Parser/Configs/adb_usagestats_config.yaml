# ADB UsageStats Log Configuration
# Version: 1.0
# Description: Configuration for parsing Android ADB usagestats logs (24-hour UI activity logs)

configSchemaVersion: "1.0"

metadata:
  logType: "adb_usagestats"
  supportedVersions: ["15"]
  displayName: "ADB UsageStats Log (Android 15)"
  description: "Parse ADB dumpsys usagestats logs for app usage, activity lifecycle, and user interaction events"
  author: "System"
  createdDate: "2025-10-04"

# File matching patterns
filePatterns:
  - "usagestats.txt"
  - "usagestats*.txt"
  - "adb_usagestats*.log"
  - "dumpsys_usagestats*.txt"

# Global parsing settings
globalSettings:
  encoding: "utf-8"
  skipEmptyLines: true
  skipComments: false
  commentPrefix: "#"
  timeSeriesOrder: "ascending"
  timestampFormat: "yyyy-MM-dd HH:mm:ss"
  
# Performance settings
performance:
  maxFileSizeMB: 500
  timeoutSeconds: 300
  bufferSizeKB: 64
  useStreamingParser: false
  parallelProcessing: false

# Error handling
errorHandling:
  onInvalidLine: "skip"
  onMissingTimestamp: "skip"
  onParsingError: "log"
  validateSchema: true

# Section definitions
sections:
  - id: "last_24_hours"
    name: "Last 24 Hour Events"
    enabled: true
    startMarker: 'Last 24 hour events'
    endMarker: 'In-memory event aggregation'
    markerType: "text"

# Line parsing rules
parsers:
  # Main UsageStats Parser
  - id: "usagestats_parser"
    name: "UsageStats Events Parser"
    enabled: true
    targetSections: ["last_24_hours"]
    priority: 1
    
    linePatterns:
      # Activity Lifecycle Events (ACTIVITY_RESUMED, ACTIVITY_PAUSED, ACTIVITY_STOPPED)
      # Example: time="2025-09-07 18:26:40" type=ACTIVITY_RESUMED package=com.sec.android.app.camera class=com.sec.android.app.camera.Camera instanceId=48273902 taskRootPackage=com.sec.android.app.camera taskRootClass=com.sec.android.app.camera.Camera flags=0x0
      - id: "activity_lifecycle_pattern"
        name: "Activity Lifecycle Event"
        regex: '^\s+time="(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})" type=(ACTIVITY_RESUMED|ACTIVITY_PAUSED|ACTIVITY_STOPPED|ACTIVITY_DESTROYED) package=([\w\.]+)(?: class=([\w\.\$]+))?(?: instanceId=(\d+))?(?: taskRootPackage=([\w\.]+))?(?: taskRootClass=([\w\.\$]+))? flags=(0x[0-9a-fA-F]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss" }
          subType: { group: 2, type: "string" }  # ACTIVITY_RESUMED, ACTIVITY_PAUSED, ACTIVITY_STOPPED, ACTIVITY_DESTROYED
          package: { group: 3, type: "string" }
          className: { group: 4, type: "string" }
          instanceId: { group: 5, type: "long" }
          taskRootPackage: { group: 6, type: "string" }
          taskRootClass: { group: 7, type: "string" }
          flags: { group: 8, type: "hex" }
        eventType: "{subType}"

      # Foreground Service Events (START/STOP)
      # Example: time="2025-09-07 18:27:30" type=FOREGROUND_SERVICE_START package=com.sec.android.app.camera class=com.sec.android.app.camera.service.NotificationService flags=0x0
      - id: "foreground_service_pattern"
        name: "Foreground Service Event"
        regex: '^\s+time="(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})" type=(FOREGROUND_SERVICE_START|FOREGROUND_SERVICE_STOP) package=([\w\.]+)(?: class=([\w\.\$]+))? flags=(0x[0-9a-fA-F]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss" }
          serviceState: { group: 2, type: "string" }  # START, STOP
          package: { group: 3, type: "string" }
          className: { group: 4, type: "string" }
          flags: { group: 5, type: "hex" }
        eventType: "FOREGROUND_SERVICE"

      # Notification Events
      # Example: time="2025-09-07 18:28:12" type=NOTIFICATION_INTERRUPTION package=com.sec.android.app.camera channelId=saving_notification_channel flags=0x0
      - id: "notification_pattern"
        name: "Notification Event"
        regex: '^\s+time="(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})" type=NOTIFICATION_INTERRUPTION package=([\w\.]+)(?: channelId=([\w\._]+))? flags=(0x[0-9a-fA-F]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss" }
          package: { group: 2, type: "string" }
          channelId: { group: 3, type: "string" }
          flags: { group: 4, type: "hex" }
        eventType: "NOTIFICATION"

      # Screen Events (INTERACTIVE/NON_INTERACTIVE)
      # Example: time="2025-09-06 19:54:46" type=SCREEN_INTERACTIVE package=android flags=0x0
      - id: "screen_state_pattern"
        name: "Screen State Event"
        regex: '^\s+time="(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})" type=(SCREEN_INTERACTIVE|SCREEN_NON_INTERACTIVE) package=([\w\.]+) flags=(0x[0-9a-fA-F]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss" }
          screenState: { group: 2, type: "string" }  # INTERACTIVE, NON_INTERACTIVE
          package: { group: 3, type: "string" }
          flags: { group: 4, type: "hex" }
        eventType: "SCREEN_STATE"

      # Keyguard Events (SHOWN/HIDDEN)
      # Example: time="2025-09-06 19:54:50" type=KEYGUARD_HIDDEN package=android flags=0x0
      - id: "keyguard_pattern"
        name: "Keyguard Event"
        regex: '^\s+time="(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})" type=(KEYGUARD_SHOWN|KEYGUARD_HIDDEN) package=([\w\.]+) flags=(0x[0-9a-fA-F]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss" }
          keyguardState: { group: 2, type: "string" }  # SHOWN, HIDDEN
          package: { group: 3, type: "string" }
          flags: { group: 4, type: "hex" }
        eventType: "KEYGUARD"

      # Standby Bucket Changed
      # Example: time="2025-09-06 18:38:32" type=STANDBY_BUCKET_CHANGED package=com.google.android.projection.gearhead standbyBucket=50 reason=t flags=0x0
      - id: "standby_bucket_pattern"
        name: "Standby Bucket Event"
        regex: '^\s+time="(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})" type=STANDBY_BUCKET_CHANGED package=([\w\.]+) standbyBucket=(\d+)(?: reason=(\w+))? flags=(0x[0-9a-fA-F]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss" }
          package: { group: 2, type: "string" }
          standbyBucket: { group: 3, type: "int" }
          reason: { group: 4, type: "string" }
          flags: { group: 5, type: "hex" }
        eventType: "STANDBY_BUCKET_CHANGED"

