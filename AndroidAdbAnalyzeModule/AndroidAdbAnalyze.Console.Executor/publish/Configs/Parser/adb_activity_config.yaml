# ADB Activity Manager Log Configuration
# Version: 1.0
# Description: Configuration for parsing Android ADB activity manager logs (URI permissions, activity starter)

configSchemaVersion: "1.0"

metadata:
  logType: "adb_activity"
  supportedVersions: ["15"]
  displayName: "ADB Activity Manager Log (Android 15)"
  description: "Parse ADB activity manager logs for URI permissions, activity lifecycle, and intent handling"
  author: "System"
  createdDate: "2025-10-04"

# File matching patterns
filePatterns:
  - "activity.txt"
  - "activity*.txt"
  - "adb_activity*.log"
  - "dumpsys_activity*.txt"

# Global parsing settings
globalSettings:
  encoding: "utf-8"
  skipEmptyLines: true
  skipComments: false
  commentPrefix: "#"
  timeSeriesOrder: "ascending"  # ascending, descending, none
  timestampFormat: "yyyy-MM-dd HH:mm:ss.fff"
  
# Performance settings
performance:
  maxFileSizeMB: 500
  timeoutSeconds: 300
  bufferSizeKB: 64
  useStreamingParser: false
  parallelProcessing: false

# Error handling
errorHandling:
  onInvalidLine: "skip"  # skip, abort, log
  onMissingTimestamp: "skip"
  onParsingError: "log"
  validateSchema: true

# Section definitions - divide log into manageable sections
sections:
  - id: "uri_permissions"
    name: "URI Permissions"
    enabled: true
    startMarker: "ACTIVITY MANAGER URI PERMISSIONS"
    endMarker: "ACTIVITY MANAGER STARTER"
    markerType: "text"
    
  - id: "activity_starter"
    name: "Activity Manager Starter"
    enabled: true
    startMarker: "ACTIVITY MANAGER STARTER"
    endMarker: "ACTIVITY MANAGER RECENT TASKS"
    markerType: "text"
    
  - id: "activities"
    name: "Activity Manager Activities"
    enabled: true
    startMarker: "ACTIVITY MANAGER ACTIVITIES"
    endMarker: "ACTIVITY MANAGER LMK KILLS"
    markerType: "text"

# Line parsing rules for each section
parsers:
  # URI Permissions Parser
  - id: "uri_permission_parser"
    name: "URI Permission Events Parser"
    enabled: true
    targetSections: ["uri_permissions"]
    priority: 1
    
    linePatterns:
      # URI GRANT pattern
      # Example: 2025-09-09 14:50:31.779: +10213<1> content://com.kakao.talk.FileProvider/... [user 0]<-com.google.android.providers.media.module
      - id: "uri_grant_pattern"
        name: "URI Permission Grant"
        regex: '^\s+(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}): \+(\d+)<(\d+)> (content://[^\[]+) \[user (\d+)\]<-(.+)$'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss.fff" }
          uid: { group: 2, type: "int" }
          refCount: { group: 3, type: "int" }
          uri: { group: 4, type: "string" }
          userId: { group: 5, type: "int" }
          provider: { group: 6, type: "string" }  # ← 모든 provider 추출
        eventType: "URI_PERMISSION_GRANT"
      
      # URI REVOKE pattern
      # Example: 2025-09-09 14:50:33.814: -10213{0} content://com.kakao.talk.FileProvider/... [user 0]
      - id: "uri_revoke_pattern"
        name: "URI Permission Revoke"
        regex: '^\s+(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}): -(\d+)\{(\d+)\} (content://[^\[]+) \[user (\d+)\]$'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy-MM-dd HH:mm:ss.fff" }
          uid: { group: 2, type: "int" }
          refCount: { group: 3, type: "int" }
          uri: { group: 4, type: "string" }
          userId: { group: 5, type: "int" }
        eventType: "URI_PERMISSION_REVOKE"

  # Activity Starter Parser
  - id: "activity_starter_parser"
    name: "Activity Starter Events Parser"
    enabled: true
    targetSections: ["activity_starter"]
    priority: 1
    
    linePatterns:
      # Activity Launch pattern (Korean timestamp format)
      # Example: 2025. 9. 9. 오후 3:08:30, Intent { act=android.intent.action.GET_CONTENT typ=image/* cmp=com.android.documentsui/.picker.PickActivity }, Reason: startActivityFromRecents
      - id: "activity_launch_pattern"
        name: "Activity Launch Event"
        regex: '^\s+(\d{4}\. \d{1,2}\. \d{1,2}\. (?:오전|오후) \d{1,2}:\d{2}:\d{2}), Intent \{ (.+?) \}, Reason: (.+)$'
        fields:
          timestamp: { group: 1, type: "datetime", format: "yyyy. M. d. (오전|오후) h:mm:ss" }
          intentData: { group: 2, type: "string" }  # Full intent string for parsing
          reason: { group: 3, type: "string" }
        eventType: "ACTIVITY_LAUNCH"
      
      # Intent action pattern extraction (for filtering intent data)
      # This is a secondary pattern to extract specific fields from intentData
      - id: "intent_action_pattern"
        name: "Intent Action Details"
        regex: '^\s+\d{4}\. \d{1,2}\. \d{1,2}\. (?:오전|오후) \d{1,2}:\d{2}:\d{2}, Intent \{ (?:act=([\w\.]+))?(?: typ=([\w/\*]+))?(?: dat=([\w:/\.]+))?(?: cmp=([\w\./]+))?.* \}'
        fields:
          action: { group: 1, type: "string" }  # android.intent.action.GET_CONTENT
          type: { group: 2, type: "string" }    # image/*
          data: { group: 3, type: "string" }    # content://...
          component: { group: 4, type: "string" }  # com.android.documentsui/.picker.PickActivity
        eventType: "INTENT_DETAILS"


