# ADB Audio Log Configuration
# Version: 1.0
# Description: Configuration for parsing Android ADB audio system logs

configSchemaVersion: "1.0"

metadata:
  logType: "adb_audio"
  supportedVersions: ["15"]
  displayName: "ADB Audio System Log (Android 15)"
  description: "Parse ADB dumpsys audio logs for playback, focus, and volume events"
  author: "System"
  createdDate: "2025-10-03"

# File matching patterns
filePatterns:
  - "audio.txt"
  - "adb_audio*.log"
  - "dumpsys_audio*.txt"

# Global parsing settings
globalSettings:
  encoding: "utf-8"
  skipEmptyLines: true
  skipComments: false
  commentPrefix: "#"
  timeSeriesOrder: "ascending"  # ascending, descending, none
  timestampFormat: "MM-dd HH:mm:ss':'fff"
  
# Performance settings
performance:
  maxFileSizeMB: 500
  timeoutSeconds: 300
  bufferSizeKB: 64
  useStreamingParser: true  # For large files
  parallelProcessing: false

# Error handling
errorHandling:
  onInvalidLine: "skip"  # skip, abort, log
  onMissingTimestamp: "skip"
  onParsingError: "log"
  validateSchema: true

# Section definitions - divide log into manageable sections
sections:
  - id: "playback_activity"
    name: "Playback Activity Monitor"
    enabled: true
    startMarker: "Events log: playback activity as reported through PlayerBase"
    endMarker: "allowed capture policies:"
    markerType: "text"  # text, regex, lineNumber
    
  - id: "focus_commands"
    name: "Focus Commands"
    enabled: true
    startMarker: "Events log: focus commands as seen by MediaFocusControl"
    endMarker: "MultiFocusStack:"
    markerType: "text"
    
  - id: "volume_changes"
    name: "Volume Changes"
    enabled: true
    startMarker: "Events log: volume changes"
    endMarker: "Events log: mute commands"
    markerType: "text"
    
  - id: "recording_activity"
    name: "Recording Activity"
    enabled: true
    startMarker: "Events log: recording activity received by AudioService"
    endMarker: "AudioDeviceBroker:"
    markerType: "text"

# Line parsing rules for each section
parsers:
  # Playback Activity Parser
  - id: "playback_parser"
    name: "Playback Events Parser"
    enabled: true
    targetSections: ["playback_activity"]
    priority: 1
    
    linePatterns:
      - id: "new_player_pattern"
        name: "New Player Created"
        regex: '^(\d{2}-\d{2} \d{2}:\d{2}:\d{2}:\d{3}) new player piid:(\d+) uid/pid:(\d+)/(\d+) package:([\w\.]+) type:([\w\.]+) attr:AudioAttributes: usage=(\w+) content=(\w+) flags=(0x[0-9a-fA-F]+) tags=([^\\s]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "MM-dd HH:mm:ss':'fff" }
          piid: { group: 2, type: "int" }
          uid: { group: 3, type: "int" }
          pid: { group: 4, type: "int" }
          package: { group: 5, type: "string" }
          playerType: { group: 6, type: "string" }
          usage: { group: 7, type: "string" }
          contentType: { group: 8, type: "string" }
          flags: { group: 9, type: "hex" }
          tags: { group: 10, type: "string" }
        eventType: "PLAYER_CREATED"
        
      - id: "player_event_pattern"
        name: "Player Event"
        regex: '^(\d{2}-\d{2} \d{2}:\d{2}:\d{2}:\d{3}) player piid:(\d+) event:(\w+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "MM-dd HH:mm:ss':'fff" }
          piid: { group: 2, type: "int" }
          event: { group: 3, type: "string" }
        eventType: "PLAYER_EVENT"
        
      - id: "player_release_pattern"
        name: "Player Released"
        regex: '^(\d{2}-\d{2} \d{2}:\d{2}:\d{2}:\d{3}) releasing player piid:(\d+), uid:(\d+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "MM-dd HH:mm:ss':'fff" }
          piid: { group: 2, type: "int" }
          uid: { group: 3, type: "int" }
        eventType: "PLAYER_RELEASED"

  # Focus Commands Parser
  - id: "focus_parser"
    name: "Audio Focus Parser"
    enabled: true
    targetSections: ["focus_commands"]
    priority: 1
    
    linePatterns:
      - id: "request_focus_pattern"
        name: "Request Audio Focus"
        regex: '^(\d{2}-\d{2} \d{2}:\d{2}:\d{2}:\d{3}) requestAudioFocus\(\) from uid/pid (\d+)/(\d+) AA=(\w+)/(\w+) clientId=([\w\.@]+) callingPack=([\w\.]+) req:(\d+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "MM-dd HH:mm:ss:fff" }
          uid: { group: 2, type: "int" }
          pid: { group: 3, type: "int" }
          usage: { group: 4, type: "string" }
          contentType: { group: 5, type: "string" }
          clientId: { group: 6, type: "string" }
          package: { group: 7, type: "string" }
          request: { group: 8, type: "int" }
        eventType: "FOCUS_REQUESTED"
        
      - id: "abandon_focus_pattern"
        name: "Abandon Audio Focus"
        regex: '^(\d{2}-\d{2} \d{2}:\d{2}:\d{2}:\d{3}) abandonAudioFocus\(\) from uid/pid (\d+)/(\d+) clientId=([\w\.@]+) callingPack=([\w\.]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "MM-dd HH:mm:ss:fff" }
          uid: { group: 2, type: "int" }
          pid: { group: 3, type: "int" }
          clientId: { group: 4, type: "string" }
          package: { group: 5, type: "string" }
        eventType: "FOCUS_ABANDONED"

  # Recording Activity Parser
  - id: "recording_parser"
    name: "Recording Activity Parser"
    enabled: true
    targetSections: ["recording_activity"]
    priority: 1
    
    linePatterns:
      - id: "rec_update_pattern"
        name: "Recording Update"
        regex: '^(\d{2}-\d{2} \d{2}:\d{2}:\d{2}:\d{3}) rec (\w+) riid:(\d+) uid:(\d+) session:(\d+) src:(\w+) (.+?) pack:([\w\.]+)'
        fields:
          timestamp: { group: 1, type: "datetime", format: "MM-dd HH:mm:ss:fff" }
          action: { group: 2, type: "string" }
          riid: { group: 3, type: "int" }
          uid: { group: 4, type: "int" }
          session: { group: 5, type: "int" }
          source: { group: 6, type: "string" }
          silenceState: { group: 7, type: "string" }
          package: { group: 8, type: "string" }
        eventType: "RECORDING_EVENT"
